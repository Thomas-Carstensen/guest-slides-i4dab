<!-- .slide: data-background="#003d73" -->
## EF Migrations

![AU Logo](./../img/aulogo_uk_var2_white.png "AU Logo") <!-- .element style="width: 200px; position: fixed; bottom: 50px; left: 50px" -->

----

### Agenda

* Connection to Server
* The why, what, where
* First migration
* Update database
* Rolling back migrations

---

## SQLite vs SQL Server

* SQLite is very lightweight 
    * Canâ€™t remove columns only add
    * Mostly used for development / tests
* SQL Server
    * Full weight database
    * Connections string are non-trivial
    * -> So from now and onwards we will use this

----

### Connection string SQL Server

* 'Server Explorer' window in Visual Studio (Menu -> View -> Server Explorer)
    * Connect to database
    * From properties menu

----

* Other ways to create connection string
    * [https://www.connectionstrings.com/sql-server-2019/](https://www.connectionstrings.com/sql-server-2019/)
    * **Note**: To use SQL Server, install nuget package and `UseSqlServer` method database connection in DbContext.OnConfiguring(..)
    * Docker:

```csharp
optionsBuilder.UseSqlServer("Data Source=127.0.0.1,1433;Database=BookStore2;User ID=SA;Password=12345678Aa#;");
```

----

### Video video video

![https://www.youtube.com/watch?v=1U0cP2rvr2g](https://www.youtube.com/watch?v=1U0cP2rvr2g)

---

## Why migrations

* It's not a feasible to delete database every time we make a change
    * Keeping Development / Production environment in sync
* Avoid making changes by hand

----

### What are migrations

* Benefits
    * Files generated by EfCore based on your OOP models
    * Keeps OOP model and database tables in sync
    * Edit database schema without losing data (development and production)
    * Provide a way to make rollbacks on database (same as in VCS)
    * Version control for database

----

### What are migrations

* Drawbacks
    * Harder to make merges in larger teams. Migrations files should be handled especially carefully

----

### Where do migrations live (1/2)

Lives in: <project-folder>/Migrations/"

Migrations file: 
```csharp
public partial class AddContactPhoneNumber : Migration {
    protected override void Up(MigrationBuilder mb) {
        mb.AddColumn<string>(
            name: "PhoneNumber",
            table: "Contacts",
            nullable: true);
    }

    protected override void Down(MigrationBuilder mb) {
        mb.DropColumn(
            name: "PhoneNumber",
            table: "Contacts");
    }}
```

----

### Where do migrations live (2/2)

<ContextClassName>ModelSnapshot.cs:

```csharp
protected override void BuildModel(ModelBuilder mb) {
  #pragma warning disable 612, 618
  mb.HasAnnotation("ProductVersion", "2.2.0-rtm-35687");
  mb.Entity("MyFirstEfCoreApp.Models.Contact", b => {
          b.Property<int>("Id")
              .ValueGeneratedOnAdd();
          b.Property<string>("Email");
          b.Property<string>("FirstName");
          b.Property<string>("LastName");
          b.Property<string>("PhoneNumber");
          b.HasKey("Id");
          b.ToTable("Contacts");
      });
      ...}
```

---

TODO: insert slide about overview 

----

## Create migration

* In Visual Studio (open Package Manager Console)
    * `PM> Add-Migration <MigrationName>`
* .Net Core cli
    * `$ dotnet ef migrations add <MigrationName>`
* Creates a CS file with timestamp and name of migration + plus creates/updates Snapshot.cs file in Migrations folder.

----

### Update database

* In Visual Studio (open Package Manager Console)
    * `PM> Update-Database`
* .Net Core cli
    * `$ dotnet ef database update`
* After this the migration(s) is **applied**


---

## Demo

![Demo](./img/demo.jpeg "Demo time")

---

### Rollback migrations (undo) - in unapplied state

* In Visual Studio (open Package Manager Console)
    * `PM> Remove-Migration <MigrationsName>`
* .Net Core cli
    * `$ dotnet ef migrations remove <MigrationName>`

----

### Rollback migrations (undo) - in applied state

* In Visual Studio (open Package Manager Console)
    * `PM> Update-Database <MigrationName-1>`
    * `PM> Remove-Migration <MigrationsName>`
* .Net Core cli
    * `$ dotnet ef database update <MigrationName-1>`
    * `$ dotnet ef migrations remove <MigrationName>`


----
 
TODO: Examples on multiple migrations

TODO: What happens in rollback

---

## Exercises :)

<!-- .slide: data-background="./img/make-homework-fun.jpg" -->

----

## References